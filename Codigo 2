<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ficha Pathfinder ‚Äî Clases / Dotes</title>
<style>
  :root{
    --bg: #071022;
    --glass: rgba(255,255,255,0.035);
    --card: rgba(18,23,32,0.6);
    --accent: rgba(255,215,0,0.06);
    --gold:#ffd24d;
    --muted:#9aa6b2;
    --glass-blur: 6px;
    --blue:#2f9be0;
    --green:#27c28b;
    --orange:#ff9f43;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#041023,#06142a);color:#e8eef6;padding:18px;}
  .app{max-width:1250px;margin:0 auto;display:grid;grid-template-columns:300px 1fr;gap:18px}
  /* SIDEBAR */
  aside{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
  .avatar{width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,#12212b,#0c1a27);display:flex;align-items:center;justify-content:center;font-size:34px;border:3px solid rgba(255,215,0,0.08)}
  .sidebar-title{font-weight:700;color:var(--gold);margin-left:10px}
  .side-row{display:flex;gap:12px;align-items:center}
  .small{font-size:0.85rem;color:var(--muted)}
  select,input{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:#eaf2ff;padding:8px 10px;border-radius:8px;width:100%}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--gold),#ffd97a);color:#081223;font-weight:700}
  .btn.secondary{background:linear-gradient(90deg,#48b0ff,#6ef0ff);color:#052033}
  .label{font-weight:700;color:var(--gold);margin-bottom:6px;display:block}

  /* MAIN */
  .main{background:transparent}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;background:transparent;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .tab.active{background:linear-gradient(90deg,rgba(255,215,0,0.06),rgba(255,215,0,0.02));color:var(--gold);font-weight:700}
  .card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(var(--glass-blur));}
  .grid-2{display:grid;grid-template-columns:1fr 420px;gap:14px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form-row{display:flex;gap:12px}
  .subhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  h3{margin:0;font-size:1rem;color:var(--gold)}
  .muted{color:var(--muted);font-size:0.9rem}

  /* CLASES UI */
  .class-tabs{display:flex;gap:8px;margin-bottom:10px}
  .class-tab{padding:6px 10px;border-radius:6px;background:rgba(255,255,255,0.02);cursor:pointer;color:var(--muted)}
  .class-tab.active{background:linear-gradient(90deg,rgba(47,155,224,0.08),rgba(47,155,224,0.02));color:var(--blue);font-weight:700}

  .class-box{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
  .stat-pill{display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.03);margin-right:8px;font-weight:700;color:var(--muted)}

  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:0.95rem}
  .smallcell{font-size:0.85rem;color:var(--muted)}

  /* DOTES y HABILIDADES */
  .two-col{display:grid;grid-template-columns:1fr 420px;gap:14px}
  .skill-row{display:grid;grid-template-columns: 1fr 70px 70px 50px 90px 80px 80px 70px;gap:8px;align-items:center;padding:6px 0}
  .skill-row header{grid-column: 1 / -1; font-weight:700;color:var(--muted);margin-top:6px}
  .skill-input{padding:6px 8px;border-radius:6px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:#eaf2ff}
  .feat{padding:10px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
  .feat.disabled{opacity:0.45;filter:grayscale(0.3)}
  .ok{color:var(--green);font-weight:700}
  .warn{color:var(--orange);font-weight:700}
  .tooltip{font-size:0.85rem;color:var(--muted)}

  /* responsive */
  @media (max-width:1100px){
    .app{grid-template-columns:1fr}
    .grid-2{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
        <div class="avatar">üßô‚Äç‚ôÄÔ∏è</div>
        <div>
          <div class="sidebar-title">Nuevo Personaje</div>
          <div class="small">Clase principal: <span id="side-main-class">‚Äî</span></div>
          <div class="small">Nivel total: <span id="side-level-total">0</span></div>
        </div>
      </div>

      <div style="margin-top:8px">
        <label class="label">Clases (elige hasta 3)</label>
        <select id="class1"></select>
        <select id="class2"></select>
        <select id="class3"></select>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="class1-level" type="number" min="0" value="1" style="width:33%;">
          <input id="class2-level" type="number" min="0" value="0" style="width:33%;">
          <input id="class3-level" type="number" min="0" value="0" style="width:33%;">
        </div>
      </div>

      <hr style="margin:12px 0;border-color:rgba(255,255,255,0.02)">

      <div>
        <label class="label">Prestigios (hasta 3)</label>
        <select id="prestige1"></select>
        <select id="prestige2"></select>
        <select id="prestige3"></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="prestige1-level" type="number" min="0" value="0" style="width:33%;">
          <input id="prestige2-level" type="number" min="0" value="0" style="width:33%;">
          <input id="prestige3-level" type="number" min="0" value="0" style="width:33%;">
        </div>
      </div>

      <hr style="margin:12px 0;border-color:rgba(255,255,255,0.02)">

      <div>
        <label class="label">Trasfondo</label>
        <select id="backgroundSelect"></select>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="saveBtn">Guardar</button>
        <button class="btn secondary" id="exportBtn">Exportar</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="tabs">
        <div class="tab active" data-tab="classesTab">Clases</div>
        <div class="tab" data-tab="prestigeTab">Prestigios</div>
        <div class="tab" data-tab="dotesTab">Dotes y Habilidades</div>
      </div>

      <!-- TAB: CLASES -->
      <div id="classesTab" class="tab-content active">
        <div class="card">
          <div class="subhead">
            <h3>Clases ‚Äî Visor y avance</h3>
            <div class="muted">Selecciona una clase en el panel lateral para ver detalles y progreso por nivel</div>
          </div>

          <div class="class-tabs" id="classSubTabs">
            <!-- din√°micos: Clase 1 / 2 / 3 -->
          </div>

          <div id="classContent">
            <div class="card class-box" id="classSummary" style="display:none">
              <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
                <div>
                  <div style="font-weight:700;font-size:1.05rem" id="className">‚Äî</div>
                  <div class="small" id="classDesc">Descripci√≥n breve de la clase (editable).</div>
                </div>
                <div style="text-align:right">
                  <div class="stat-pill">HD: <span id="classHD">d8</span></div>
                  <div class="stat-pill">Progr. BAB: <span id="classBAB">medio</span></div>
                  <div class="stat-pill">Salv: <span id="classSaves">F/D/D</span></div>
                </div>
              </div>

              <hr style="margin:10px 0;border-color:rgba(255,255,255,0.03)">

              <div style="display:flex;gap:12px">
                <div style="flex:1">
                  <label class="small">Nivel actual (esta clase)</label>
                  <input id="classCurrentLevel" type="number" min="0" value="1" style="width:110px">
                </div>
                <div style="flex:1">
                  <label class="small">Modo HP</label>
                  <select id="hpMode" style="width:140px">
                    <option value="avg">Promedio</option>
                    <option value="max">M√°ximo (HD)</option>
                  </select>
                </div>
                <div style="flex:1">
                  <label class="small">Mod CON (actual)</label>
                  <input id="conMod" type="number" value="0" style="width:110px">
                </div>
                <div style="flex:1">
                  <label class="small">Acciones</label>
                  <div style="display:flex;gap:8px">
                    <button id="applyClassLevel" class="btn">Aplicar</button>
                    <button id="resetClass" class="btn" style="background:rgba(255,255,255,0.03);color:var(--muted)">Reset</button>
                  </div>
                </div>
              </div>

              <div style="margin-top:12px">
                <h4 style="margin:0;color:var(--muted)">Avance por niveles (parcial para esta clase)</h4>
                <table id="classProgressTable">
                  <thead>
                    <tr><th>Nivel</th><th>BAB</th><th>HP acumulado</th><th>Fort</th><th>Ref</th><th>Vol</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            </div>
          </div>

        </div>
      </div>

      <!-- TAB: PRESTIGIO -->
      <div id="prestigeTab" class="tab-content" style="display:none">
        <div class="card">
          <div class="subhead">
            <h3>Prestigios ‚Äî Resumen</h3>
            <div class="muted">Tres ranuras de prestigio. Selecciona uno en la barra lateral y ajusta niveles.</div>
          </div>

          <div id="prestigeContent">
            <div class="card class-box">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div style="font-weight:700" id="prestName">‚Äî</div>
                  <div class="small" id="prestDesc">Descripci√≥n de prestigio</div>
                </div>
                <div>
                  <div class="stat-pill">BAB prog: <span id="prestBAB">medio</span></div>
                  <div class="stat-pill">HD: <span id="prestHD">d8</span></div>
                </div>
              </div>

              <div style="margin-top:12px">
                <label class="small">Nivel en prestigio</label>
                <input id="prestigeCurrentLevel" type="number" min="0" value="0" style="width:100px">
                <button id="applyPrestige" class="btn" style="margin-left:8px">Aplicar</button>
              </div>

              <div style="margin-top:12px">
                <h4 style="margin:0;color:var(--muted)">Progresi√≥n (preview)</h4>
                <table id="prestProgressTable">
                  <thead><tr><th>Nivel</th><th>BAB</th><th>HP</th><th>Fort</th><th>Ref</th><th>Vol</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- TAB: DOTES Y HABILIDADES -->
      <div id="dotesTab" class="tab-content" style="display:none">
        <div class="card">
          <div class="subhead">
            <h3>Dotes y Habilidades</h3>
            <div class="muted">Izquierda: habilidades ‚Äî Derecha: dotes. Las dotes se habilitan seg√∫n nivel efectivo y prerrequisitos.</div>
          </div>

          <div class="two-col">
            <!-- HABILIDADES -->
            <div class="card class-box">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700;color:var(--muted)">Habilidades</div>
                <div class="small">Puntos disponibles: <span id="skillPoints">0</span></div>
              </div>

              <div style="margin-top:10px;max-height:420px;overflow:auto" id="skillsList">
                <!-- din√°mico: filas de habilidad -->
              </div>
            </div>

            <!-- DOTES -->
            <div class="card class-box">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:700;color:var(--muted)">Dotes</div>
                <div class="small">Slots disponibles: <span id="featSlots">0</span></div>
              </div>

              <div style="max-height:520px;overflow:auto" id="featsList">
                <!-- din√°mico: lista de dotes -->
              </div>
            </div>
          </div>

        </div>
      </div>

    </main>
  </div>

<script>
/* -----------------------------------------------------------
   Datos base (ejemplos): clases, prestigios, dotes y habilidades
   -> Reemplaza/compl√©ta con tus listas reales cuando quieras.
   ----------------------------------------------------------- */
const CLASSES = [
  { id:'guerrero', name:'Guerrero', hd:10, bab:'alto', saves:{fort:'fuerte',ref:'debil',vol:'debil'}, skills: ['Artesan√≠a','Intimidar'], desc:'Luchador vers√°til.' },
  { id:'mago', name:'Mago', hd:6, bab:'bajo', saves:{fort:'debil',ref:'debil',vol:'fuerte'}, skills:['Conocimiento (arcano)','Ling√º√≠stica'], desc:'Usuario de conjuros arcanos.' },
  { id:'picaro', name:'P√≠caro', hd:8, bab:'medio', saves:{fort:'debil',ref:'fuerte',vol:'debil'}, skills:['Sigilo','Juego de manos'], desc:'Astuto y sigiloso.' },
  { id:'clerigo', name:'Cl√©rigo', hd:8, bab:'medio', saves:{fort:'fuerte',ref:'debil',vol:'fuerte'}, skills:['Curar','Saber (religi√≥n)'], desc:'Servidor de una deidad.' },
  { id:'bardo', name:'Bardo', hd:8, bab:'medio', saves:{fort:'debil',ref:'fuerte',vol:'fuerte'}, skills:['Interpretar','Diplomacia'], desc:'Artista con magia.' },
  // a√±ade el resto...
];

const PRESTIGES = [
  { id:'arquero_arcano', name:'Arquero Arcano', hd:8, bab:'medio', desc:'Prestigio mezcla de arquer√≠a y conjuro.' },
  { id:'asesino', name:'Asesino', hd:8, bab:'medio', desc:'Especialista en muerte s√∫bita.' },
  // a√±ade m√°s seg√∫n tu lista...
];

const FEATS = [
  { id:'preciso', name:'Disparo Preciso', prereq:{dex:13}, desc:'Reduce penalizaci√≥n por disparo a distancia.' },
  { id:'ataque_furtivo_bm', name:'Ataque Furtivo Mejorado', prereq:{feat:'Ataque Furtivo'}, desc:'Mejora da√±o de ataque furtivo.' },
  { id:'tirador', name:'Tirador', prereq:{dex:15}, desc:'Mayor alcance y da√±o con arcos.' },
  // a√±ade las dotes reales...
];

const SKILLS = [
  { id:'acro', name:'Acrobacias', attr:'DES', armorPen:-1 },
  { id:'artesania', name:'Artesan√≠a', attr:'INT', armorPen:0 },
  { id:'sigilo', name:'Sigilo', attr:'DES', armorPen:1 },
  { id:'percepcion', name:'Percepci√≥n', attr:'SAB', armorPen:0 },
  { id:'diplomacia', name:'Diplomacia', attr:'CAR', armorPen:0 },
  { id:'conocimiento', name:'Conocimiento (arcano)', attr:'INT', armorPen:0 },
  // a√±ade la lista completa m√°s tarde...
];

/* -----------------------------------------------------------
   XP por nivel (tabla que me diste)
   ----------------------------------------------------------- */
const XP_TABLE = { 1:0, 2:3000, 3:7500, 4:14000, 5:23000, 6:35000, 7:53000, 8:77000, 9:115000, 10:160000,
 11:235000,12:330000,13:475000,14:665000,15:955000,16:1350000,17:1675000,18:2700000,19:3850000,20:5350000 };

/* -----------------------------------------------------------
   Utilidades de progresi√≥n (BAB / saves / HP promedio)
   - BAB: 'alto', 'medio', 'bajo'
   - Saves: 'fuerte' / 'debil' (fuerte empieza en 2 en nivel 1)
   ----------------------------------------------------------- */
function babForProgression(prog, level){
  if(level<=0) return 0;
  if(prog==='alto') return level;                    // aproximaci√≥n: alto = +1 por nivel
  if(prog==='medio') return Math.floor(level * 0.75); // aproximaci√≥n
  return Math.floor(level * 0.5);                    // bajo
}
function saveForProgression(progression, level){
  // aproximaci√≥n simple:
  if(level<=0) return 0;
  if(progression==='fuerte'){
    // starts at +2 at lvl1, then +1 every 2 levels
    return 2 + Math.floor((level-1)/2);
  } else {
    // starts at 0 at lvl1, +1 every 3 levels
    return Math.floor(level/3);
  }
}
function avgHPForHD(hd, level, mode){
  // hd: 6,8,10,12 (d6,d8,d10,d12)
  if(level<=0) return 0;
  if(mode==='max') return level * hd;
  // promedio: (hd/2)+1 como promedio por nivel (standard)
  return Math.floor(level * (Math.floor(hd/2)+1));
}

/* -----------------------------------------------------------
   Estado del personaje (b√°sico)
   ----------------------------------------------------------- */
const state = {
  classes: [null,null,null],            // {id, level}
  prestiges: [null,null,null],          // {id, level}
  background: null,
  conMod: 0,
  totalLevels: 0,
  totalBAB: 0,
  totalHP: 0,
  totalSaves: {fort:0,ref:0,vol:0},
  featSlots: 0,
  skillPoints: 0,
  assignedFeats: [],
  assignedSkills: {} // skillId -> ranks etc
};

/* -----------------------------------------------------------
   Inicializaci√≥n DOM: llena selects con datos
   ----------------------------------------------------------- */
function populateSelects(){
  const c1 = document.getElementById('class1');
  const c2 = document.getElementById('class2');
  const c3 = document.getElementById('class3');
  const p1 = document.getElementById('prestige1');
  const p2 = document.getElementById('prestige2');
  const p3 = document.getElementById('prestige3');
  const bg = document.getElementById('backgroundSelect');

  // helper
  function addOptions(sel, items){
    sel.innerHTML = '<option value="">‚Äî</option>';
    items.forEach(it => {
      const opt = document.createElement('option');
      opt.value = it.id;
      opt.text = it.name;
      sel.appendChild(opt);
    });
  }

  addOptions(c1, CLASSES); addOptions(c2, CLASSES); addOptions(c3, CLASSES);
  addOptions(p1, PRESTIGES); addOptions(p2, PRESTIGES); addOptions(p3, PRESTIGES);
  // backgrounds: use a short example list (reemplaza con la tuya)
  const backgrounds = ['Ninguno','Ac√≥lito','Artesano','Charlat√°n','Campesino','Criminal','Erudito','Soldado'];
  bg.innerHTML = '';
  backgrounds.forEach(b => {
    const opt = document.createElement('option'); opt.value=b; opt.text=b; bg.appendChild(opt);
  });
}
populateSelects();

/* -----------------------------------------------------------
   Eventos: cuando el usuario selecciona clases/prestigios
   ----------------------------------------------------------- */
function attachSidebarEvents(){
  ['class1','class2','class3','class1-level','class2-level','class3-level',
   'prestige1','prestige2','prestige3','prestige1-level','prestige2-level','prestige3-level',
   'backgroundSelect','conMod'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('change', onSidebarChange);
  });

  document.getElementById('applyClassLevel').addEventListener('click', ()=> {
    // aplicar valores actuales de classCurrentLevel a la clase seleccionada activa
    const active = document.querySelector('.class-tab.active');
    if(!active) return;
    const idx = parseInt(active.dataset.idx,10); // 0|1|2
    const level = parseInt(document.getElementById('classCurrentLevel').value)||0;
    const selId = document.querySelectorAll('#class1,#class2,#class3')[idx].value;
    if(!selId) { alert('Elige una clase en la ranura correspondiente.'); return; }
    state.classes[idx] = { id: selId, level };
    recalcAll();
  });

  document.getElementById('applyPrestige').addEventListener('click', ()=>{
    const lvl = parseInt(document.getElementById('prestigeCurrentLevel').value)||0;
    const sel = document.querySelector('#prestige1,#prestige2,#prestige3');
    // simple: put into first prestige slot that matches currently selected prestige
    const currentPrestige = document.querySelector('#prestige1,#prestige2,#prestige3'); // just refresh later
    // we update based on the prestige select fields state (user sets the select in sidebar)
    readSidebarClassesPrestiges();
    recalcAll();
    alert('Prestigio aplicado (vista previa).');
  });

  // tabs
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', (e)=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const tab = e.currentTarget.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    document.getElementById(tab).style.display='block';
  }));
}
attachSidebarEvents();

/* -----------------------------------------------------------
   Leer selects de sidebar a state
   ----------------------------------------------------------- */
function readSidebarClassesPrestiges(){
  const classesSel = [document.getElementById('class1').value, document.getElementById('class2').value, document.getElementById('class3').value];
  const classesLv = [parseInt(document.getElementById('class1-level').value)||0, parseInt(document.getElementById('class2-level').value)||0, parseInt(document.getElementById('class3-level').value)||0];

  state.classes = classesSel.map((id,i)=> id ? { id, level: classesLv[i] } : null );

  const prestSel = [document.getElementById('prestige1').value, document.getElementById('prestige2').value, document.getElementById('prestige3').value];
  const prestLv = [parseInt(document.getElementById('prestige1-level').value)||0, parseInt(document.getElementById('prestige2-level').value)||0, parseInt(document.getElementById('prestige3-level').value)||0];
  state.prestiges = prestSel.map((id,i)=> id ? { id, level: prestLv[i] } : null);

  state.background = document.getElementById('backgroundSelect').value;
  state.conMod = parseInt(document.getElementById('conMod').value)||0;
}

/* -----------------------------------------------------------
   Recalcular todo: niveles, BAB, HP, salvaciones, dotes slots, skills points
   ----------------------------------------------------------- */
function recalcAll(){
  readSidebarClassesPrestiges();
  // totals:
  let lvlSum = 0;
  let totalBAB = 0;
  let totalHP = 0;
  let totFort=0, totRef=0, totVol=0;

  // classes
  state.classes.forEach(slot=>{
    if(!slot) return;
    const cls = CLASSES.find(c=>c.id===slot.id);
    if(!cls) return;
    const level = slot.level;
    lvlSum += level;
    totalBAB += babForProgression(cls.bab==='alto' ? 'alto' : (cls.bab==='medio'? 'medio' : 'bajo'), level);
    totalHP += avgHPForHD(cls.hd, level, 'avg') + (state.conMod * level);
    totFort += saveForProgression(cls.saves.fort==='fuerte'?'fuerte':'debil', level);
    totRef  += saveForProgression(cls.saves.ref==='fuerte'?'fuerte':'debil', level);
    totVol  += saveForProgression(cls.saves.vol==='fuerte'?'fuerte':'debil', level);
  });

  // prestiges
  state.prestiges.forEach(p=>{
    if(!p) return;
    const pr = PRESTIGES.find(x=>x.id===p.id);
    if(!pr) return;
    const lvl = p.level;
    lvlSum += lvl;
    // assume prestige has 'medio' bab unless specified
    totalBAB += babForProgression(pr.bab || 'medio', lvl);
    totalHP += avgHPForHD(pr.hd || 8, lvl, 'avg') + (state.conMod * lvl);
    // rudimentary saves: treat prestige as medium for all
    totFort += saveForProgression('fuerte', Math.floor(lvl/2)); // simplified
    totRef  += saveForProgression('debil', Math.floor(lvl/2));
    totVol  += saveForProgression('debil', Math.floor(lvl/2));
  });

  state.totalLevels = lvlSum;
  state.totalBAB = totalBAB;
  state.totalHP = totalHP;
  state.totalSaves = { fort: totFort, ref: totRef, vol: totVol };

  // feat slots: simple rule ‚Äî 1 feat per odd level starting at 1 (1,3,5...). Count = floor((level+1)/2)
  state.featSlots = Math.floor((state.totalLevels + 1) / 2);
  // skill points: simple placeholder: 4 per level total (DM can edit)
  state.skillPoints = state.totalLevels * 4;

  // update UI
  document.getElementById('side-level-total').innerText = state.totalLevels;
  document.getElementById('side-main-class').innerText = (state.classes[0] ? CLASSES.find(c=>c.id===state.classes[0].id).name + ' ' + state.classes[0].level : '‚Äî');
  updateClassTabs();
  updatePrestigeView();
  updateDotesHabilidadesUI();
}

/* -----------------------------------------------------------
   DIBUJAR tabs de clase seg√∫n las ranuras (1..3)
   ----------------------------------------------------------- */
function updateClassTabs(){
  const container = document.getElementById('classSubTabs');
  container.innerHTML='';
  const classSlots = [document.getElementById('class1').value, document.getElementById('class2').value, document.getElementById('class3').value];
  classSlots.forEach((clsId, idx)=>{
    const tab = document.createElement('div');
    tab.className='class-tab';
    tab.dataset.idx = idx;
    tab.innerText = clsId ? (CLASSES.find(c=>c.id===clsId).name + ' (' + (document.getElementById(['class1-level','class2-level','class3-level'][idx]).value||0) + ')') : `Ranura ${idx+1}`;
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.class-tab').forEach(x=>x.classList.remove('active'));
      tab.classList.add('active');
      renderClassContent(idx);
    });
    container.appendChild(tab);
  });
  // auto-click first tab
  const first = container.querySelector('.class-tab');
  if(first) first.click();
}

/* -----------------------------------------------------------
   Render del panel de la clase seleccionada (detalle)
   ----------------------------------------------------------- */
function renderClassContent(idx){
  const clsId = document.querySelectorAll('#class1,#class2,#class3')[idx].value;
  const content = document.getElementById('classSummary');
  if(!clsId){ content.style.display='none'; return; }
  const cls = CLASSES.find(c=>c.id===clsId);
  content.style.display='block';
  document.getElementById('className').innerText = cls.name;
  document.getElementById('classDesc').innerText = cls.desc;
  document.getElementById('classHD').innerText = 'd' + cls.hd;
  document.getElementById('classBAB').innerText = cls.bab;
  document.getElementById('classSaves').innerText = `${cls.saves.fort[0].toUpperCase()}/${cls.saves.ref[0].toUpperCase()}/${cls.saves.vol[0].toUpperCase()}`;
  // fill current level
  const lvlField = document.getElementById('classCurrentLevel');
  const slotLevel = parseInt(document.getElementById(['class1-level','class2-level','class3-level'][idx]).value) || 0;
  lvlField.value = slotLevel;
  // populate table
  const tbody = document.querySelector('#classProgressTable tbody');
  tbody.innerHTML='';
  const mode = document.getElementById('hpMode').value;
  const conMod = parseInt(document.getElementById('conMod').value)||0;
  for(let i=1;i<=Math.max(1,slotLevel);i++){
    const tr = document.createElement('tr');
    const bab = babForProgression(cls.bab, i);
    const hp = avgHPForHD(cls.hd, i, mode) + (conMod * i);
    const fort = saveForProgression(cls.saves.fort, i);
    const ref = saveForProgression(cls.saves.ref, i);
    const vol = saveForProgression(cls.saves.vol, i);
    tr.innerHTML = `<td>${i}</td><td>${bab}</td><td>${hp}</td><td>${fort}</td><td>${ref}</td><td>${vol}</td>`;
    tbody.appendChild(tr);
  }
}

/* -----------------------------------------------------------
   PRESTIGE: preview de progresi√≥n
   ----------------------------------------------------------- */
function updatePrestigeView(){
  const sel = document.getElementById('prestige1').value || document.getElementById('prestige2').value || document.getElementById('prestige3').value;
  const element = document.getElementById('prestName');
  if(!sel){ element.innerText='‚Äî'; document.getElementById('prestDesc').innerText='Elige un prestigio en la barra lateral.'; return; }
  const prest = PRESTIGES.find(p=>p.id===sel);
  element.innerText = prest.name;
  document.getElementById('prestDesc').innerText = prest.desc || 'Prestigio.';
  document.getElementById('prestBAB').innerText = prest.bab || 'medio';
  document.getElementById('prestHD').innerText = 'd' + (prest.hd || 8);
  // populate table
  const tbody = document.querySelector('#prestProgressTable tbody'); tbody.innerHTML='';
  const lvl = parseInt(document.getElementById('prestige1-level').value) || 0;
  for(let i=1;i<=lvl;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i}</td><td>${babForProgression(prest.bab||'medio', i)}</td><td>${avgHPForHD(prest.hd||8,i,'avg')}</td><td>--</td><td>--</td><td>--</td>`;
    tbody.appendChild(tr);
  }
}

/* -----------------------------------------------------------
   DOTES y HABILIDADES: UI
   ----------------------------------------------------------- */
function updateDotesHabilidadesUI(){
  // update counts
  document.getElementById('featSlots').innerText = state.featSlots;
  document.getElementById('skillPoints').innerText = state.skillPoints;

  // populate skills list
  const skillsDiv = document.getElementById('skillsList');
  skillsDiv.innerHTML='';
  SKILLS.forEach(s=>{
    const row = document.createElement('div');
    row.className='skill-row';
    row.innerHTML = `
      <div style="font-weight:700">${s.name}</div>
      <div><input class="skill-input" data-skill="${s.id}" data-col="base" type="number" value="0"></div>
      <div><input class="skill-input" data-skill="${s.id}" data-col="ranks" type="number" value="0"></div>
      <div style="text-align:center"><input class="skill-input" data-skill="${s.id}" data-col="classcheck" type="checkbox"></div>
      <div><input class="skill-input" data-skill="${s.id}" data-col="racial" type="number" value="0"></div>
      <div><input class="skill-input" data-skill="${s.id}" data-col="misc" type="number" value="0"></div>
      <div><input class="skill-input" data-skill="${s.id}" data-col="armor" type="number" value="${s.armorPen||0}"></div>
      <div style="text-align:right"><span class="smallcell" id="skill_total_${s.id}">0</span></div>
    `;
    skillsDiv.appendChild(row);
  });

  // wire up change events on skill inputs
  skillsDiv.querySelectorAll('.skill-input').forEach(inp=>{
    inp.addEventListener('input', ()=> recalcSkills());
  });

  // populate feats
  const featsDiv = document.getElementById('featsList'); featsDiv.innerHTML='';
  FEATS.forEach(f=>{
    const el = document.createElement('div');
    el.className = 'feat';
    el.id = 'feat_'+f.id;
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${f.name}</div>
        <div class="small">${f.prereq ? 'Requisitos presentados' : ''}</div>
      </div>
      <div class="tooltip small" style="margin-top:6px">${f.desc}</div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <label class="small">Seleccionar</label>
        <input type="checkbox" data-feat="${f.id}" />
      </div>
    `;
    featsDiv.appendChild(el);
  });

  // wire up feats checkboxes and run initial validation
  featsDiv.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.addEventListener('change', handleFeatToggle));
  validateFeats();
  recalcSkills();
}

/* -----------------------------------------------------------
   recalcula skills totals
   ----------------------------------------------------------- */
function recalcSkills(){
  SKILLS.forEach(s=>{
    const base = parseInt(document.querySelector(`[data-skill="${s.id}"][data-col="base"]`).value)||0;
    const ranks = parseInt(document.querySelector(`[data-skill="${s.id}"][data-col="ranks"]`).value)||0;
    const racial = parseInt(document.querySelector(`[data-skill="${s.id}"][data-col="racial"]`).value)||0;
    const misc = parseInt(document.querySelector(`[data-skill="${s.id}"][data-col="misc"]`).value)||0;
    const armor = parseInt(document.querySelector(`[data-skill="${s.id}"][data-col="armor"]`).value)||0;
    // attribute mod placeholder: 0 (en el futuro vincular a atributos reales)
    const attrMod = 0;
    const total = base + ranks + racial + misc + attrMod - armor;
    document.getElementById('skill_total_'+s.id).innerText = total;
  });
}

/* -----------------------------------------------------------
   Validaci√≥n/activaci√≥n de feats (dotes)
   - chequea requisitos simples: atributo m√≠nimo, feats previas, nivel m√≠nimo, BAB m√≠nimo
   ----------------------------------------------------------- */
function validateFeats(){
  // Determina nivel efectivo
  const level = state.totalLevels;

  FEATS.forEach(f=>{
    const el = document.getElementById('feat_'+f.id);
    let ok = true;
    const reasons = [];
    if(f.prereq){
      if(f.prereq.str && (0 < f.prereq.str) ) { /* placeholder */ }
      if(f.prereq.dex && (0 < f.prereq.dex) ) { /* placeholder */ }
      if(f.prereq.feat){
        // check if selected
        const already = state.assignedFeats.includes(f.prereq.feat);
        if(!already){ ok=false; reasons.push('Requiere dote previa: '+f.prereq.feat); }
      }
      // nivel
      if(f.prereq.level && level < f.prereq.level){ ok=false; reasons.push('Requiere nivel '+f.prereq.level); }
    }
    if(!ok) el.classList.add('disabled'); else el.classList.remove('disabled');
    // tooltip add reasons
    const tip = el.querySelector('.tooltip');
    tip.innerText = f.desc + (reasons.length? ' ‚Äî ' + reasons.join('; ') : '');
  });
}

/* -----------------------------------------------------------
   Handler al marcar/unmarcar dote
   ----------------------------------------------------------- */
function handleFeatToggle(e){
  const id = e.currentTarget.dataset.feat;
  if(e.currentTarget.checked){
    // check if allowed
    if(document.getElementById('feat_'+id).classList.contains('disabled')){
      alert('No cumple requisitos para seleccionar esta dote.');
      e.currentTarget.checked=false;
      return;
    }
    state.assignedFeats.push(id);
  } else {
    state.assignedFeats = state.assignedFeats.filter(x=>x!==id);
  }
  validateFeats();
}

/* -----------------------------------------------------------
   onSidebarChange: recalcula todo y actualiza UI
   ----------------------------------------------------------- */
function onSidebarChange(){
  // read values into state
  readSidebarClassesPrestiges();
  recalcAll();
}

/* -----------------------------------------------------------
   Inicializa el UI por primera vez
   ----------------------------------------------------------- */
(function init(){
  // set default con mod field
  document.getElementById('conMod').value = 0;
  // set default background
  document.getElementById('backgroundSelect').value = 'Ninguno';
  // initial recalc
  recalcAll();
  // wire hpMode changes to update class content
  document.getElementById('hpMode').addEventListener('change', ()=> {
    const active = document.querySelector('.class-tab.active');
    if(active) renderClassContent(parseInt(active.dataset.idx,10));
  });
  // when class selection changes, refresh tabs
  document.querySelectorAll('#class1,#class2,#class3').forEach(s=>s.addEventListener('change', ()=>{ updateClassTabs(); recalcAll(); }));
  document.querySelectorAll('#class1-level,#class2-level,#class3-level').forEach(s=>s.addEventListener('input', ()=>{ updateClassTabs(); recalcAll(); }));
  document.querySelectorAll('#prestige1,#prestige2,#prestige3,#prestige1-level,#prestige2-level,#prestige3-level').forEach(x=>x.addEventListener('change', ()=>{ updatePrestigeView(); recalcAll(); }));
  // wire save/export (placeholders)
  document.getElementById('saveBtn').addEventListener('click', ()=> alert('Guardar: funcionalidad no implementada en demo.'));
  document.getElementById('exportBtn').addEventListener('click', ()=> alert('Exportar: funcionalidad no implementada en demo.'));
})();
</script>
</body>
</html>
